<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-PAT: 양육태도 검사</title>
    <!-- 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #3498db; --secondary-color: #2ecc71;
            --analysis-color: #e67e22; --pdf-color: #8e44ad; --text-color: #333;
            --bg-light: #f4f7f9; --bg-white: #ffffff; --border-color: #e0e0e0;
            --score-high-color: #3498db; --score-low-color: #e74c3c;
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        body { font-family: var(--font-main); line-height: 1.6; background-color: var(--bg-light); color: var(--text-color); margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px 30px; background-color: var(--bg-white); border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: #2c3e50; }
        h3 { text-align: left; color: var(--primary-color); border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 25px; margin-bottom: 15px; }
        h3:first-child { margin-top: 0; }
        .page-section { display: none; }
        #selection-container { display: block; text-align: center; padding: 40px 20px; }
        .start-button { display: inline-block; width: 250px; padding: 20px; font-size: 20px; font-weight: bold; color: var(--bg-white); border: none; border-radius: 8px; cursor: pointer; margin: 10px; transition: all 0.3s; }
        .start-button:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .start-button.parent { background-color: var(--primary-color); } .start-button.parent:hover { background-color: #2980b9; }
        .start-button.child { background-color: var(--secondary-color); } .start-button.child:hover { background-color: #27ae60; }
        .action-button { display: block; width: 100%; padding: 15px; font-size: 18px; font-weight: bold; color: var(--bg-white); border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        .pdf-btn { background-color: var(--pdf-color); } .pdf-btn:hover { background-color: #732d91; }
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: none; justify-content: center; align-items: center; z-index: 9999; text-align: center;}
        .loader p { font-size: 1.2em; color: var(--text-color); background: var(--bg-white); padding: 20px 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
        #begin-q-btn { background-color: #FFEB3B; color: #000; border: 1px solid #FBC02D; margin-top: 25px; } #begin-q-btn:hover { background-color: #FDD835; }
        #submit-btn { background-color: #bdc3c7; color: #ffffff; cursor: not-allowed; }
        #submit-btn.active { background-color: #FFEB3B; color: #000; cursor: pointer; border: 1px solid #FBC02D; } #submit-btn.active:hover { background-color: #FDD835; }
        .question-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
        .nav-button { padding: 10px 20px; font-size: 16px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--bg-white); cursor: pointer; }
        .nav-button:disabled { background-color: #f0f0f0; cursor: not-allowed; color: #aaa; }
        #progress-indicator { font-weight: bold; }
        .info-form-wrapper { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px 30px; background-color: #fafafa; }
        .info-form-header { text-align: center; margin-bottom: 25px; }
        .info-form-header h2 { margin: 0 0 5px 0; color: #2c3e50; }
        .info-form-header p { margin: 0; font-size: 0.9em; color: #7f8c8d; }
        .info-table { width: 100%; border-collapse: collapse; }
        .info-table th, .info-table td { border: 1px solid #ddd; padding: 12px; }
        .info-table th { background-color: #f2f2f2; font-weight: bold; text-align: left; width: 120px; }
        .info-table input[type="text"], .info-table input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .gender-options { display: flex; gap: 20px; align-items: center; }
        .gender-options label { margin: 0; font-weight: normal; }
        .instructions { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 25px; border-left: 5px solid var(--primary-color); }
        .question-item { margin-bottom: 25px; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; background-color: #fafafa; }
        .question-text { font-weight: bold; margin-bottom: 10px; }
        .options { display: flex; justify-content: space-around; flex-wrap: wrap; }
        .options label { margin: 5px 10px; cursor: pointer; display: inline-flex; align-items: center; }
        input[type="radio"] { margin-right: 8px; transform: scale(1.2); }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .results-header h2 { margin: 0; text-align: left; font-size: 1.5em; flex-grow: 1; }
        .restart-btn { padding: 8px 15px; font-size: 14px; border-radius: 20px; background-color: #95a5a6; color: white; border: none; cursor: pointer; transition: background-color 0.3s; white-space: nowrap; }
        .restart-btn:hover { background-color: #7f8c8d; }
        .result-scale-card, .test-taker-info-card { background-color: var(--bg-white); border: 1px solid var(--border-color); border-radius: 5px; padding: 20px; margin-bottom: 20px; page-break-inside: avoid; }
        .table-responsive-wrapper { overflow-x: auto; }
        
        .detailed-scores-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; table-layout: fixed; }
        .detailed-scores-table th, .detailed-scores-table td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
        .detailed-scores-table th { background-color: #e9ecef; font-size: 0.8em; font-weight: 600; word-break: keep-all; vertical-align: middle; }
        
        .test-taker-info-table { width: 100%; border-collapse: collapse; }
        .test-taker-info-table td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
        .test-taker-info-table .label { background-color: #e9ecef; font-weight: bold; }

        .detailed-scores-table .scale-name-col { text-align: left; font-weight: bold; background-color: #f2f2f2; width: 160px; }
        .score { font-weight: bold; font-size: 1.1em; }

        #general-assessment-text { padding: 10px; line-height: 1.8; text-align: left; }
        #general-assessment-text p { margin-bottom: 1em; }
        .review-scale-container { page-break-inside: avoid; background-color: #fff; padding-bottom: 1px;}
        .review-scale-header { padding: 10px 15px; margin-top: 20px; margin-bottom: 15px; background-color: #f8f9fa; border-left: 5px solid; border-radius: 4px; }
        .review-scale-header:first-child { margin-top: 0; }
        .review-scale-header h4 { text-align: left; margin: 0; color: #495057; font-size: 1.1em; border: none; padding: 0;}
        .question-review-list { list-style-type: none; padding: 0; margin: 0 0 15px 0; }
        .question-review-item { padding: 15px 8px; border-bottom: 1px solid #f1f3f5; }
        .question-review-item:last-child { border-bottom: none; }
        .review-item-main { display: flex; justify-content: space-between; align-items: center; }
        .review-question-text { flex-grow: 1; margin-right: 15px; font-size: 0.95em; }
        .user-response-badge { padding: 3px 10px; border-radius: 15px; color: white; font-size: 0.85em; font-weight: bold; white-space: nowrap; flex-shrink: 0; border: 2px solid transparent; }
        .follow-up-q-box-inline { background-color: #fefcf7; padding: 12px; border-radius: 4px; border: 1px solid #fdeed6; margin-top: 12px; font-size: 0.9em; }
        .follow-up-q-box-inline strong { font-weight: bold; }
        @media (max-width: 768px) {
            .container { padding: 10px; margin: 10px; } h1 { font-size: 1.5em; } .start-button { display: block; width: 100%; box-sizing: border-box; }
            .options { flex-direction: column; align-items: flex-start; } .options label { margin: 8px 0; width: 100%; }
            .review-item-main { flex-direction: column; align-items: flex-start; }
            .user-response-badge { margin-top: 8px; }
        }
        @media print { .results-header, .action-buttons, .restart-btn { display: none !important; } h3 { color: #000 !important; } .result-scale-card, .test-taker-info-card { box-shadow: none; border: 1px solid #ccc; } }
    </style>
</head>
<body>
    <div class="loader"><p></p></div>
    <div class="container">
        <div id="selection-container" class="page-section"><h1>AI-PAT: 양육태도 검사</h1><p>진행할 항목을 선택해주세요.</p><button class="start-button parent" onclick="selectTestType('parent')">부모용 검사 시작</button><button class="start-button child" onclick="selectTestType('child')">자녀용 검사 시작</button></div>
        <div id="user-info-container" class="page-section"></div>
        <div id="test-container" class="page-section"></div>
        <div id="results-page" class="page-section"></div>
    </div>
    
    <template id="user-info-template">
        <div class="info-form-wrapper">
            <div class="info-form-header"><h2 id="info-form-title"></h2><p>정확한 결과 분석을 위해 아래 정보를 기입해주세요.</p></div>
            <form id="user-info-form">
                <table class="info-table"><tbody><tr><th>이름</th><td><input type="text" id="user-name" required></td></tr><tr><th>성별</th><td><div class="gender-options"><label><input type="radio" name="gender" value="남성" required> 남성</label><label><input type="radio" name="gender" value="여성" required> 여성</label></div></td></tr><tr><th>나이 (세)</th><td><input type="number" id="user-age" required></td></tr><tr><th>연락처</th><td><input type="text" id="user-contact" placeholder="010-1234-5678" oninput="formatPhoneNumber(this)" maxlength="13" required></td></tr><tr id="additional-info-name-row" style="display: none;"></tr><tr id="additional-info-age-row" style="display: none;"></tr></tbody></table>
                <button type="button" id="begin-q-btn" class="action-button" onclick="beginQuestionnaire()">검사 시작</button>
            </form>
        </div>
    </template>
    
    <template id="test-template">
        <h1 id="test-title"></h1><div id="test-instructions" class="instructions"><p><strong>검사 안내</strong></p><p id="instruction-text"></p></div>
        <form id="pat-form"></form>
        <div class="question-nav"><button id="prev-btn" class="nav-button" onclick="goToPrevPage()">이전</button><span id="progress-indicator"></span><button id="next-btn" class="nav-button" onclick="goToNextPage()">다음</button><button id="submit-btn" class="nav-button" style="display:none;" onclick="showResults()">결과보기</button></div>
    </template>

    <template id="results-template">
        <div id="results-content">
            <div class="results-header" data-html2canvas-ignore="true"><h2 id="results-title"></h2><button class="restart-btn" onclick="restartTest()">처음으로</button></div>
            <div id="summary-section"><div id="test-taker-info" class="test-taker-info-card"></div><div id="total-scores-chart-card" class="result-scale-card"><h3>척도별 총점 그래프</h3><canvas id="total-scores-chart" style="max-height: 350px;"></canvas></div><div id="general-assessment-card" class="result-scale-card"><h3>양육태도 총평</h3><div id="general-assessment-text"></div></div></div>
            <div id="detailed-scores-card" class="result-scale-card"><h3>문항별 점수 상세표</h3><div class="table-responsive-wrapper"><div id="detailed-scores-container"></div></div></div>
            <div id="all-questions-review-card" class="result-scale-card"><h3>척도별 문항 상세 분석</h3><div id="all-questions-review-container"></div></div>
        </div>
        <div class="action-buttons" data-html2canvas-ignore="true">
            <button type="button" class="action-button pdf-btn" onclick="downloadResultsAsPdf()">결과 보고서 PDF로 저장</button>
            <button type="button" class="action-button" onclick="printResults()" style="background-color: #7f8c8d;">간편 인쇄 (브라우저)</button>
        </div>
    </template>
    
    <script>
    // Google Apps Script URL (배포 후 반드시 교체)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwgpwXpjnMwvR3wmHH8hF1e6dtjcH8NJyXgCYba-lZDAd1psuuFXq4Og6WPvRZjUVj_/exec';
    const { jsPDF } = window.jspdf;
    
    const CONSTANTS = { SCALE_NAMES: { 'A1': '지지적 표현', 'A2': '합리적 설명', 'B3': '성취 지향 통제', 'B4': '과잉보호적 통제', 'C5': '적대적 통제' }, SCALE_COLORS: { 'A1': '#3498db', 'A2': '#2ecc71', 'B3': '#f1c40f', 'B4': '#e67e22', 'C5': '#e74c3c' }, RESPONSE_TEXT: { 1: '전혀 그렇지 않다', 2: '그렇지 않은 편이다', 3: '그런 편이다', 4: '매우 그렇다' }, QUESTIONS_PER_PAGE: 5, INSTRUCTION_TEXTS: { parent: '본 검사는 부모로서 자신의 양육 태도를 돌아보기 위해 만들어진 가상 검사입니다. 아래 40개의 문항을 읽고, 자녀를 대하는 평소 자신의 생각이나 행동과 가장 가깝다고 생각하는 곳에 솔직하게 응답해 주십시오.', child: '본 검사는 부모님의 양육 태도를 어떻게 느끼고 있는지 알아보기 위한 가상 검사입니다. 아래 40개 문항을 읽고, 부모님의 평소 행동과 가장 가깝다고 생각하는 곳에 솔직하게 응답해 주십시오.' } };
    
    const QUESTION_KEYWORDS = { 
        A1: ['과정 칭찬', '애정 표현', '의견 존중', '감정 공감', '성공 축하', '장점 언급', '즐거운 시간', '관심사 대화'], 
        A2: ['규칙 설명', '대화로 해결', '자율적 결정', '대안 제시', '의사결정 참여', '약속 지키기', '자제력', '사생활 존중'], 
        B3: ['타인 비교', '조건적 애정', '놀이 통제', '조기 교육', '계획 강요', '실망 표현', '의견 무시', '친구 개입'], 
        B4: ['실패 차단', '문제 직접 해결', '과잉 준비', '수시 확인', '활동 제한', '선택 유도', '어려움 예측', '소유물 침해'], 
        C5: ['분노 표출', '체벌', '자녀 탓', '과거 잘못 지적', '단점 지적', '비일관성', '감정 무시', '의심/다그침'] 
    };

    const DB = {
        questionSets: {
            parent: [ { scale: 'A1', text: '결과가 좋지 않더라도, 노력한 과정 자체를 칭찬해준다.' },{ scale: 'A1', text: '‘사랑한다’, ‘네가 자랑스럽다’와 같은 애정 표현을 자주 하는 편이다.' },{ scale: 'A1', text: '자녀의 의견이 나와 다르더라도, 끝까지 들어보고 존중하려고 노력한다.' },{ scale: 'A1', text: '자녀가 속상해하거나 힘들어할 때, 그 감정을 있는 그대로 공감해준다.' },{ scale: 'A1', text: '자녀의 사소한 성공이나 성취에도 함께 기뻐하며 축하해준다.' },{ scale: 'A1', text: '자녀의 장점과 긍정적인 면을 자주 이야기해준다.' },{ scale: 'A1', text: '자녀와 함께 웃고 장난치는 등 즐거운 시간을 보내기 위해 노력한다.' },{ scale: 'A1', text: '자녀의 관심사(좋아하는 연예인, 게임 등)에 대해 열린 마음으로 대화한다.' },{ scale: 'A2', text: '집안의 규칙을 정할 때, 왜 필요한지 이유를 충분히 설명해준다.' },{ scale: 'A2', text: '잘못된 행동을 했을 때, 소리치기보다 무엇이 문제였는지 대화로 푼다.' },{ scale: 'A2', text: '자녀가 스스로 생각하고 판단해서 결정할 수 있도록 기회를 주고 기다린다.' },{ scale: 'A2', text: '무언가를 금지해야 할 때, 대안을 함께 찾아보려고 노력한다.' },{ scale: 'A2', text: '중요한 결정을 내릴 때, 자녀의 의견을 묻고 결정 과정에 참여시킨다.' },{ scale: 'A2', text: '자녀와의 약속은 사소한 것이라도 꼭 지키려고 노력한다.' },{ scale: 'A2', text: '자녀가 스스로 해야 할 일을 대신 해주는 것을 자제하는 편이다.' },{ scale: 'A2', text: '자녀의 프라이버시(일기, 개인적인 메시지 등)를 존중해준다.' },{ scale: 'B3', text: '자녀를 다른 아이와 비교하며 더 잘해야 한다고 자극을 주는 편이다.' },{ scale: 'B3', text: '자녀가 좋은 성적이나 결과를 가져왔을 때 주로 애정을 표현한다.' },{ scale: 'B3', text: '자녀의 미래 성공을 위해 현재의 놀이 시간은 통제해야 한다고 생각한다.' },{ scale: 'B3', text: '자녀의 재능을 키우기 위해 다소 힘든 교육도 필요하다고 믿는다.' },{ scale: 'B3', text: '자녀의 하루 일과를 학습 중심으로 짜주고 그대로 따르기를 기대한다.' },{ scale: 'B3', text: '자녀의 성적이 떨어지면, 걱정하는 마음에서 실망감을 표현하게 된다.' },{ scale: 'B3', text: '‘다 너 잘되라고 하는 소리’라며 자녀의 불만을 받아주지 않을 때가 있다.' },{ scale: 'B3', text: '자녀의 친구 관계가 학업에 방해가 된다고 판단되면 개입한다.' },{ scale: 'B4', text: '자녀가 실패를 경험하지 않도록 어려운 일은 미리 막아준다.' },{ scale: 'B4', text: '자녀의 친구 문제나 학교 문제에 내가 직접 나서서 해결해준다.' },{ scale: 'B4', text: '자녀의 모든 준비물과 스케줄은 내가 완벽하게 챙겨야 마음이 놓인다.' },{ scale: 'B4', text: '자녀가 외출하면 누구와 어디에 있는지 수시로 확인해야 안심이 된다.' },{ scale: 'B4', text: '자녀가 다칠까 봐 신체적인 활동이나 바깥 활동을 제한하는 편이다.' },{ scale: 'B4', text: '자녀의 선택이 마음에 들지 않으면, 결국 내가 원하는 방향으로 유도한다.' },{ scale: 'B4', text: '자녀가 겪을 어려움을 예측하고 미리 다 해결해 주려고 한다.' },{ scale: 'B4', text: '자녀를 위해서라면 자녀의 물건을 허락 없이 정리하거나 버릴 수 있다.' },{ scale: 'C5', text: '자녀의 행동이 마음에 들지 않으면, 화를 내거나 소리를 지를 때가 있다.' },{ scale: 'C5', text: '자녀가 잘못했을 때, 벌을 주거나 체벌을 하는 것이 효과적이라 생각한다.' },{ scale: 'C5', text: '“너 때문에 못살겠다”와 같이 자녀를 탓하는 말을 무심코 할 때가 있다.' },{ scale: 'C5', text: '자녀의 실수나 잘못을 오랫동안 기억하고 지적하는 편이다.' },{ scale: 'C5', text: '자녀를 칭찬하기보다는 잘못된 점을 지적해서 고쳐주려고 한다.' },{ scale: 'C5', text: '내 기분에 따라 자녀를 대하는 태도가 달라질 때가 있다.' },{ scale: 'C5', text: '자녀의 감정적인 요구(위로, 공감 등)를 귀찮아할 때가 있다.' },{ scale: 'C5', text: '자녀의 말을 믿기보다, 의심하거나 다그쳐서 사실을 확인할 때가 있다.' }],
            child: [ { scale: 'A1', text: '내가 시험을 못 보거나 실패해도, 부모님은 노력한 것에 대해 칭찬해주신다.' },{ scale: 'A1', text: '부모님은 나에게 ‘사랑한다’고 말해주거나 자주 안아주는 등 애정 표현을 자주 하신다.' },{ scale: 'A1', text: '내 생각이 부모님과 달라도, 부모님은 내 이야기를 끝까지 들어주고 존중해주려고 하신다.' },{ scale: 'A1', text: '내가 슬퍼하거나 화를 낼 때, 부모님은 내 마음을 이해하고 위로해주신다.' },{ scale: 'A1', text: '내가 작은 것이라도 잘 해내면, 부모님은 자신의 일처럼 기뻐하며 축하해주신다.' },{ scale: 'A1', text: '부모님은 내 단점보다는 장점을 찾아서 자주 칭찬해주시는 편이다.' },{ scale: 'A1', text: '부모님은 나와 함께 놀거나 장난치며 즐겁게 시간을 보내는 것을 좋아하신다.' },{ scale: 'A1', text: '내가 좋아하는 것들에 대해 이야기할 때, 부모님은 관심을 갖고 대화에 참여해주신다.' },{ scale: 'A2', text: '부모님은 어떤 규칙을 지켜야 할 때, 왜 그 규칙이 필요한지 알기 쉽게 설명해주신다.' },{ scale: 'A2', text: '내가 잘못했을 때, 부모님은 화부터 내기보다 대화를 통해 해결하려고 하신다.' },{ scale: 'A2', text: '부모님은 내가 스스로 결정하도록 믿고 기다려주신다.' },{ scale: 'A2', text: '부모님은 무언가를 못하게 하실 때, 대신 할 수 있는 다른 방법을 함께 찾아주신다.' },{ scale: 'A2', text: '우리 집의 중요한 일을 결정할 때, 부모님은 내 의견을 물어보고 존중해주신다.' },{ scale: 'A2', text: '부모님은 나와 한 약속을 잊지 않고 잘 지켜주신다.' },{ scale: 'A2', text: '부모님은 내가 혼자 할 수 있는 일은 스스로 하도록 맡겨두는 편이다.' },{ scale: 'A2', text: '부모님은 내 일기장이나 휴대폰을 허락 없이 보지 않는 등 내 사생활을 존중해주신다.' },{ scale: 'B3', text: '부모님은 나를 다른 친구들과 비교하며 말씀하실 때가 많다.' },{ scale: 'B3', text: '내가 시험을 잘 보거나 상을 탔을 때, 특히 더 사랑받는다고 느낀다.' },{ scale: 'B3', text: '부모님은 내가 노는 시간보다는 공부하는 시간을 더 중요하게 생각하신다.' },{ scale: 'B3', text: '부모님은 내가 힘들어해도, 장래를 위해 참으라고 말씀하신다.' },{ scale: 'B3', text: '부모님은 내 하루 일과와 시간 계획을 대부분 정해주신다.' },{ scale: 'B3', text: '성적이 떨어지면 부모님은 나에게 크게 실망했다는 것을 드러내신다.' },{ scale: 'B3', text: '부모님은 "다 널 위해서야"라고 말하며 내 의견을 들어주지 않을 때가 있다.' },{ scale: 'B3', text: '부모님은 내 친구 관계가 공부에 방해된다고 생각하시면 간섭하실 때가 있다.' },{ scale: 'B4', text: '내가 새로운 것을 해보고 싶다고 하면, 부모님은 위험하다며 못하게 하신다.' },{ scale: 'B4', text: '내가 친구랑 싸우면, 부모님이 직접 내 친구나 그 부모님께 연락하신다.' },{ scale: 'B4', text: '내 준비물이나 숙제는 내가 챙기기 전에 부모님이 미리 다 챙겨주신다.' },{ scale: 'B4', text: '내가 밖에 나가면, 부모님에게서 어디인지 묻는 연락이 자주 온다.' },{ scale: 'B4', text: '부모님은 다칠 수 있다면서, 내가 하고 싶어 하는 활동적인 놀이를 못 하게 하신다.' },{ scale: 'B4', text: '내가 무언가를 고르면, 결국에는 부모님이 원하는 것으로 바꾸게 될 때가 많다.' },{ scale: 'B4', text: '부모님은 내가 어려움을 겪기 전에 미리 모든 것을 해결해주시려고 한다.' },{ scale: 'B4', text: '부모님은 내 물건을 나에게 물어보지 않고 정리하거나 버리실 때가 있다.' },{ scale: 'C5', text: '부모님은 내 행동이 마음에 안 드시면, 나에게 화를 내거나 소리를 지르신다.' },{ scale: 'C5', text: '내가 크게 잘못하면, 부모님은 벌을 서게 하거나 매를 드실 때가 있다.' },{ scale: 'C5', text: '부모님은 "너 때문에 힘들다"는 식의 말을 하실 때가 있다.' },{ scale: 'C5', text: '부모님은 내가 예전에 잘못했던 일을 자꾸 꺼내서 말씀하신다.' },{ scale: 'C5', text: '부모님은 나를 칭찬해주기보다 내 잘못이나 단점을 더 자주 말씀하신다.' },{ scale: 'C5', text: '부모님의 기분에 따라 나를 대하는 방식이 크게 달라진다.' },{ scale: 'C5', text: '내가 속상해서 이야기하면 부모님은 귀찮아하거나 건성으로 들으실 때가 있다.' },{ scale: 'C5', text: '부모님은 내 말을 믿어주기보다, 정말인지 아닌지 자꾸 되물어보며 확인하신다.' } ]
        },
        followUpQuestions: { parent: { 'A1': [ { q1: "결과가 좋지 않을 때 과정 칭찬을 하기 어려운 이유는 무엇인가요?", q4: "과정에 대한 칭찬이 자녀에게 어떤 긍정적 영향을 준다고 생각하시나요?" }, { q1: "자녀에게 사랑한다는 표현을 하는 것이 어색하게 느껴지시나요?", q4: "애정 표현이 자녀와의 관계에서 얼마나 중요하다고 느끼시나요? " }, { q1: "자녀의 의견이 어리석거나 틀렸다고 느낄 때가 많으신가요?", q4: "나와 다른 자녀의 의견을 존중하는 나만의 방법이 있다면 무엇인가요?" }, { q1: "자녀의 감정에 공감하기보다 이성적인 해결책을 제시하려는 편이신가요?", q4: "자녀의 감정을 공감해 주었을 때, 자녀가 보였던 가장 인상적인 반응은 무엇이었나요?" }, { q1: "자녀의 성공이 기대에 미치지 못한다고 생각하여 축하하기 어려우신가요?", q4: "작은 성공을 함께 기뻐하는 것이 자녀의 도전 정신에 어떤 영향을 줄까요?" }, { q1: "자녀의 단점이 먼저 눈에 들어와 장점을 찾기 어려우신가요?", q4: "자녀의 어떤 장점을 이야기해 줄 때 가장 기분이 좋으신가요?" }, { q1: "자녀와 함께 보내는 시간이 의무처럼 느껴질 때가 있으신가요?", q4: "자녀와 즐거운 시간을 보내기 위해 가장 즐겨 하는 활동은 무엇인가요?" }, { q1: "자녀의 관심사를 이해할 수 없거나 시간 낭비라고 생각하시나요?", q4: "자녀의 관심사에 대해 대화하는 것이 관계에 어떤 도움이 되었나요?" } ], 'A2': [ { q1: "규칙을 정할 때 자녀에게 설명하는 과정이 불필요하다고 생각하시나요?", q4: "이유를 설명해 주었을 때, 자녀가 규칙을 더 잘 따랐던 경험이 있나요?" }, { q1: "큰 소리를 내는 것이 대화보다 빠르고 효과적이라고 느끼실 때가 있나요?", q4: "대화로 문제를 풀어나가는 모습을 통해 자녀가 무엇을 배우길 바라시나요?" }, { q1: "자녀의 결정을 믿고 기다려주는 것이 불안하게 느껴지시나요?", q4: "자녀가 스스로 내린 결정 중 가장 자랑스러웠던 것은 무엇인가요?" }, { q1: "자녀가 원하는 것을 무조건 금지하는 것이 더 쉽다고 느껴지시나요?", q4: "대안을 함께 찾는 과정에서 자녀와의 관계가 어떻게 변화했나요?" }, { q1: "중요한 결정은 어른이 하는 것이 당연하다고 생각하시나요?", q4: "자녀를 의사결정에 참여시켰을 때 어떤 긍정적인 점이 있었나요?" }, { q1: "상황에 따라 자녀와의 약속을 지키지 못하는 경우가 많으신가요?", q4: "부모가 약속을 지키는 모습이 자녀의 인성에 어떤 영향을 준다고 믿으시나요?" }, { q1: "자녀가 일을 서툴게 할 때 답답해서 그냥 해주고 싶다는 생각이 드시나요?", q4: "자녀가 스스로 무언가를 해냈을 때 어떤 감정을 느끼시나요?" }, { q1: "자녀의 프라이버시를 어디까지 존중해야 할지 혼란스러우신가요?", q4: "자녀의 사생활을 존중해 주는 것이 신뢰 형성에 얼마나 중요할까요?" } ], 'B3': [ { q1: "자녀를 남과 비교하는 것은 자존감만 해친다고 생각하시나요?", q4: "자녀를 다른 아이와 비교했을 때, 어떤 반응을 보였는지 구체적으로 말씀해주시겠어요?" }, { q1: "자녀의 성과와 상관없이 늘 사랑을 표현하는 것이 중요하다고 믿으시나요?", q4: "성과에 따라 애정 표현이 달라지는 것이 자녀에게 어떤 메시지를 준다고 생각하시나요?" }, { q1: "자녀가 충분히 놀고 쉬는 것이 더 중요하다고 생각하시나요?", q4: "미래 성공을 위해 현재의 즐거움을 포기해야 한다고 생각하는 이유는 무엇인가요?" }, { q1: "자녀가 힘들어하는 것을 보면 교육을 중단하고 싶다는 생각이 드시나요?", q4: "자녀의 재능을 위해 교육을 강행했을 때, 어떤 갈등이나 어려움을 겪으셨나요?" }, { q1: "자녀가 스스로 계획을 짜고 실천하도록 격려하는 편이신가요?", q4: "부모가 짜준 학습 계획을 자녀가 잘 따르지 않을 때 어떤 기분이 드시나요?" }, { q1: "성적이 떨어져도 괜찮다고 다독여주는 것이 맞다고 생각하시나요?", q4: "자녀에게 실망감을 표현한 후에 어떤 후회나 미안함을 느끼신 적이 있나요?" }, { q1: "자녀가 불만을 표현하면, 그 이유를 먼저 들어주는 편이신가요?", q4: "‘다 너 잘되라고 하는 소리’라는 말 뒤에 숨겨진 부모님의 진짜 마음은 무엇인가요?" }, { q1: "자녀의 친구 관계는 자녀 스스로 만들어가는 것이라고 믿으시나요?", q4: "자녀의 친구 관계에 개입해야겠다고 결심하게 된 구체적인 계기가 있었나요?" } ], 'B4': [ { q1: "자녀가 실패를 통해 스스로 배우는 것이 중요하다고 생각하시나요?", q4: "자녀가 실패를 경험하지 않도록 보호하는 것이 부모의 가장 중요한 역할이라고 생각하시나요?" }, { q1: "자녀가 친구나 학교 문제를 스스로 해결하도록 지켜보는 편이신가요?", q4: "내가 직접 나서서 해결해 주었을 때, 문제가 더 빠르고 쉽게 해결되었던 경험이 있으신가요?" }, { q1: "자녀가 자기 물건을 스스로 챙기는 것이 당연하다고 생각하시나요?", q4: "자녀의 모든 것을 챙겨주지 않으면 어떤 불안한 마음이 드시나요?" }, { q1: "자녀가 어디에 있든 믿고 기다려주는 편이신가요?", q4: "자녀의 위치를 수시로 확인하지 않으면 어떤 최악의 상황이 상상되시나요?" }, { q1: "자녀가 다양한 신체 활동을 통해 마음껏 에너지를 발산하기를 바라시나요?", q4: "자녀가 다칠까 봐 활동을 제한했을 때, 자녀는 어떤 반응을 보였나요?" }, { q1: "자녀가 스스로 선택한 것을 존중하고 지지해주는 편이신가요?", q4: "자녀의 선택을 부모님이 원하는 방향으로 유도하는 것이 결국 자녀에게 더 좋은 길이라고 믿으시나요?" }, { q1: "자녀가 어려움을 겪더라도 스스로 이겨내도록 지켜보는 것이 중요하다고 생각하시나요?", q4: "자녀가 겪을 어려움을 미리 해결해주고 싶은 부모님의 마음은 어디에서 비롯된 것일까요?" }, { q1: "자녀의 물건은 자녀의 소유이므로 함부로 만져선 안 된다고 생각하시나요?", q4: "자녀를 위해 물건을 정리해주었을 때, 자녀와 갈등을 겪은 경험이 있으신가요?" } ], 'C5': [ { q1: "어떤 상황에서도 자녀에게 화를 내거나 소리치지 않으려고 노력하시나요?", q4: "화나 소리를 지르고 난 후에, 자녀와의 관계에 어떤 변화가 있었나요?" }, { q1: "체벌은 어떤 상황에서도 정당화될 수 없다고 생각하시나요?", q4: "체벌 외에 다른 훈육 방법은 효과가 없다고 느끼셨던 경험이 있으신가요?" }, { q1: "내 감정이나 행동의 책임을 자녀에게 돌리지 않으려고 의식적으로 노력하시나요?", q4: "자녀를 탓하는 말을 했을 때, 가장 크게 후회했던 순간은 언제였나요?" }, { q1: "자녀의 실수는 지나간 일이므로 다시 꺼내지 않는 것이 좋다고 생각하시나요?", q4: "자녀의 과거 잘못을 반복해서 지적하는 것이 자녀의 행동 개선에 도움이 된다고 믿으시나요?" }, { q1: "자녀의 긍정적인 면을 찾아 칭찬하는 것이 더 효과적인 훈육이라고 생각하시나요?", q4: "자녀의 잘못을 지적할 때, 어떤 감정을 느끼며 말씀하시나요?" }, { q1: "일관적인 태도를 유지하는 것이 자녀의 안정감에 중요하다고 생각하시나요?", q4: "부모님의 기분에 따라 자녀를 대하는 태도가 달라진다는 것을 스스로 인지하고 계신가요?" }, { q1: "자녀가 위로나 공감을 원할 때, 그 감정을 충분히 받아주는 편이신가요?", q4: "자녀의 감정적인 요구가 귀찮다고 느껴질 때, 부모님 스스로는 어떤 상태이신 것 같나요?" }, { q1: "기본적으로 자녀의 말을 신뢰하고, 의심하지 않으려고 노력하시나요?", q4: "자녀의 말을 믿기 어려웠던 구체적인 사건이나 경험이 있으셨나요?" } ] },
            child: { 'A1': [ { q1: "부모님이 노력을 칭찬해주지 않을 때 어떤 기분이 드나요?", q4: "부모님이 내 노력을 알아주고 칭찬해주실 때 어떤 마음이 드나요?" }, { q1: "부모님께 사랑한다는 말을 듣지 못할 때 서운한가요?", q4: "부모님께 사랑한다는 말을 들으면 어떤 기분이 드나요?" }, { q1: "부모님께 내 의견을 무시당했다는 느낌이 들 때가 있나요? 그때 기분은 어떤가요?", q4: "부모님께서 내 의견을 존중해주실 때 어떤 점이 좋은가요?" }, { q1: "내가 속상할 때 부모님이 내 마음을 몰라주면 어떤가요?", q4: "부모님이 내 마음을 알아주고 위로해주시면 어떤 기분이 드나요?" }, { q1: "내가 무언가를 잘 해냈는데 부모님이 알아주지 않으면 서운한가요?", q4: "부모님이 나처럼 기뻐해주실 때 어떤 점이 가장 좋은가요?" }, { q1: "부모님께 주로 단점을 지적받을 때 기분이 어떤가요?", q4: "부모님이 내 장점을 칭찬해주실 때 기분이 어떤가요?" }, { q1: "부모님과 함께 노는 시간이 부족하다고 느낀 적 있나요?", q4: "부모님과 함께 즐거운 시간을 보내면 어떤 점이 가장 좋나요?" }, { q1: "내가 좋아하는 것을 부모님께 이야기하기 어려울 때가 있나요? 이유는 무엇인가요?", q4: "부모님과 내가 좋아하는 것에 대해 이야기 나눌 때 기분이 어떤가요?" } ], 'A2': [ { q1: "부모님이 이유를 설명해주지 않고 규칙을 지키라고만 할 때 어떤 생각이 드나요?", q4: "부모님이 왜 그래야 하는지 잘 설명해주시면 어떤 점이 좋은가요?" }, { q1: "잘못했을 때 부모님이 화부터 내시면 어떤 마음이 드나요?", q4: "부모님이 화내지 않고 차분히 이야기해주시면 어떤 점이 다른가요?" }, { q1: "부모님이 나를 믿지 못하고 다 정해주려고 할 때 기분이 어떤가요?", q4: "부모님이 나를 믿고 기다려주실 때 어떤 기분이 드나요?" }, { q1: "부모님이 무조건 '안돼'라고만 하시면 어떤 마음이 드나요?", q4: "부모님이 다른 방법을 같이 찾아주시면 기분이 어떤가요?" }, { q1: "중요한 일에 내 의견이 빠지면 서운한가요?", q4: "부모님이 내 의견을 물어봐주시면 어떤 기분이 드나요?" }, { q1: "부모님이 약속을 안 지키면 어떤 기분이 드나요?", q4: "부모님이 나와의 작은 약속도 잘 지켜주실 때 어떤 기분이 드나요?" }, { q1: "부모님이 내가 할 일을 대신 해줄 때 어떤 생각이 드나요?", q4: "내가 스스로 무언가를 해냈을 때 부모님이 지켜봐 주시면 어떤 기분인가요?" }, { q1: "부모님이 내 사생활을 존중해주지 않는다고 느낄 때 어떤 기분인가요?", q4: "부모님께서 내 사생활을 존중해주실 때 어떤 점이 좋다고 느끼나요?" } ], 'B3': [ { q1: "다른 친구와 비교 당할 때 기분이 어떤지 솔직하게 이야기해줄 수 있나요?", q4: "부모님이 비교하는 말을 자주 하시는 것 같나요? 그렇다면 어떤 기분이 드나요?" }, { q1: "혹시 시험을 잘 봤을 때만 부모님이 나를 사랑한다고 느낀 적 있나요?", q4: "성과와 상관없이 사랑받는다고 느낄 때는 언제인가요?" }, { q1: "공부하느라 노는 시간이 부족해서 속상할 때가 있나요?", q4: "놀이 시간을 줄여서라도 공부를 더 해야 한다고 생각하나요?" }, { q1: "공부나 학원이 너무 힘들다고 느낄 때 부모님께 이야기하기 어려운가요?", q4: "부모님께서 내가 힘든 것을 알면서도 계속 시키실 때 어떤 기분이 드나요?" }, { q1: "부모님이 짜준 계획대로만 생활하는 것이 답답하게 느껴질 때가 있나요?", q4: "내가 스스로 계획을 세워서 해보고 싶다는 생각이 드나요?" }, { q1: "성적이 떨어졌을 때 부모님의 실망한 표정을 보면 어떤 마음이 드나요?", q4: "부모님께서 나에게 실망감을 보이실 때, 어떤 생각이 가장 많이 드나요?" }, { q1: "'다 널 위해서야'라는 말을 들으면 어떤 기분이 드나요?", q4: "부모님께서 내 의견을 들어주지 않고 이렇게 말씀하실 때, 정말 나를 위한 것이라고 느껴지나요?" }, { q1: "부모님이 내 친구 관계를 간섭하는 것에 대해 어떻게 생각하나요?", q4: "부모님 때문에 친구와 멀어진 경험이 있나요? 그때 기분이 어땠나요?" } ], 'B4': [ { q1: "부모님 때문에 새로운 것을 해보지 못해서 아쉬웠던 적이 있나요?", q4: "부모님께서 '위험하다'고 말씀하시는 것이 정말 위험하다고 생각하나요, 아니면 너무 걱정하시는 것 같나요?" }, { q1: "친구와의 문제를 부모님이 해결해 주시는 게 편한가요, 아니면 불편한가요?", q4: "부모님이 대신 해결해주셨을 때, 문제가 정말 잘 해결되었다고 생각하나요?" }, { q1: "내가 스스로 준비물을 챙길 수 있는데 부모님이 다 챙겨주실 때 어떤가요?", q4: "부모님이 모든 것을 챙겨주시는 게 좋을 때도 있고, 싫을 때도 있나요?" }, { q1: "부모님께 계속 어디 있는지 알려드리는 것이 귀찮거나 감시받는 느낌이 드나요?", q4: "부모님의 잦은 연락이 걱정 때문이라고 느껴지나요, 아니면 나를 믿지 못해서라고 느껴지나요?" }, { q1: "몸으로 뛰어노는 것을 좋아하는데 부모님이 못하게 해서 속상한 적이 있나요?", q4: "부모님이 '다친다'는 이유로 못하게 하시는 활동 중에 정말 하고 싶은 것이 있나요?" }, { q1: "내가 고른 것을 부모님이 마음에 들어 하지 않아 바꿨을 때 기분이 어땠나요?", q4: "부모님이 정해준 대로 하는 게 결국 더 좋다고 생각하나요?" }, { q1: "내가 힘든 일을 겪기 전에 부모님이 다 해결해주시면 어떤 점이 좋고 어떤 점이 아쉬운가요?", q4: "모든 것을 부모님이 해결해주시는 것이 나에게 정말 도움이 된다고 생각하나요?" }, { q1: "부모님이 내 물건을 마음대로 버리거나 정리했을 때 어떤 기분이 들었나요?", q4: "그 물건이 나에게 얼마나 소중했는지 부모님께 이야기해본 적이 있나요?" } ], 'C5': [ { q1: "부모님이 나에게 화내거나 소리 지르실 때, 어떤 생각이 드나요?", q4: "부모님이 화내거나 소리 지르고 난 후에, 나에게 어떻게 해주시나요?" }, { q1: "벌을 받거나 맞을 때 가장 먼저 드는 생각이나 느낌은 무엇인가요?", q4: "벌을 받거나 맞고 나면, 내 잘못을 뉘우치게 되나요, 아니면 억울하거나 무서운 마음이 더 큰가요?" }, { q1: "부모님이 '너 때문에 힘들다'고 말씀하시면 어떤 기분이 드나요?", q4: "그런 말을 들으면 '내가 정말 잘못했구나'라는 생각이 드나요, 아니면 다른 생각이 드나요?" }, { q1: "부모님이 옛날에 잘못한 일을 자꾸 이야기하실 때 기분이 어떤가요?", q4: "이미 끝난 일을 다시 꺼내는 것이 나에게 도움이 된다고 생각하나요?" }, { q1: "칭찬보다 지적을 더 많이 듣는다고 느낀다면, 기분이 어떤가요?", q4: "부모님께서 내 잘못을 지적하실 때, 어떤 마음으로 듣게 되나요?" }, { q1: "부모님의 기분에 따라 나를 대하는 게 달라져서 힘들었던 적이 있나요?", q4: "부모님의 기분이 좋아 보일 때와 나빠 보일 때, 나의 행동도 달라지나요?" }, { q1: "내가 속상해서 이야기하는데 부모님이 귀찮아하시는 것 같으면 어떤가요?", q4: "그럴 때 '이제 이야기하지 말아야지' 하는 생각이 드나요?" }, { q1: "부모님이 내 말을 믿어주지 않고 자꾸 캐물을 때 어떤 기분이 드나요?", q4: "내가 거짓말을 하고 있지 않은데도 의심받으면 어떤 생각이 드나요?" } ] }
        },
        assessmentTexts: { A1: { highest: "<strong>'지지적 표현'</strong>이 가장 두드러지는 특징입니다. 자녀에게 정서적 안정감과 사랑을 충분히 전달하려는 따뜻한 양육자입니다.", lowest: "<strong>'지지적 표현'</strong>이 부족한 경향이 있습니다. 때로는 결과 중심적인 태도나 무뚝뚝함으로 인해 자녀가 정서적 지지를 충분히 받지 못한다고 느낄 수 있습니다." }, A2: { highest: "<strong>'합리적 설명'</strong>이 가장 두드러지는 특징입니다. 자녀를 독립된 인격체로 존중하며, 이성적이고 민주적인 방식으로 소통하는 것을 중요하게 생각합니다.", lowest: "<strong>'합리적 설명'</strong>이 부족한 경향이 있습니다. 일방적인 지시나 통제가 대화를 대체하기 쉬우며, 이로 인해 자녀의 자율성 발달이 저해될 수 있습니다." }, B3: { highest: "<strong>'성취 지향 통제'</strong>가 가장 두드러지는 특징입니다. 자녀의 미래 성공과 성취에 대한 기대치가 높으며, 이를 위해 현재를 통제하고 관리하려는 경향이 강합니다.", lowest: "<strong>'성취 지향 통제'</strong>를 거의 사용하지 않습니다. 자녀의 성과나 결과보다는 과정의 즐거움과 자율적인 선택을 더 중요하게 생각하는 양육 태도를 보입니다." }, B4: { highest: "<strong>'과잉보호적 통제'</strong>가 가장 두드러지는 특징입니다. 자녀를 향한 염려와 불안감이 높아, 자녀가 겪을 수 있는 모든 실패와 어려움으로부터 보호하려는 경향이 강합니다.", lowest: "<strong>'과잉보호적 통제'</strong>를 거의 사용하지 않습니다. 자녀가 스스로 어려움을 헤쳐나가며 성장할 수 있도록 믿고 지켜봐 주는 경향이 있습니다." }, C5: { highest: "<strong>'적대적 통제'</strong>가 가장 두드러지는 특징입니다. 훈육 과정에서 비난, 분노 표출, 처벌과 같은 강압적인 방식을 사용하는 경향이 있습니다. 이는 부모님의 스트레스나 소진 상태와 관련이 있을 수 있습니다.", lowest: "<strong>'적대적 통제'</strong>를 거의 사용하지 않습니다. 자녀와 갈등 상황이 발생하더라도 감정적인 대응을 자제하고 안정적인 태도를 유지하려 노력하는 모습이 돋보입니다." }, conclusion: { positive: "이러한 긍정적인 양육 자원은 자녀와의 관계를 더욱 돈독하게 만드는 소중한 기반이 될 것입니다. 지금처럼 꾸준히 노력해 주세요.", neutral: "자신의 양육 방식을 돌아보고 강점과 약점을 파악하는 것은 매우 의미 있는 과정입니다. 부족한 점을 조금씩 보완해 나간다면 더욱 긍정적인 관계를 맺을 수 있을 것입니다.", warning: "현재 양육 과정에서 어려움을 겪고 있을 수 있습니다. 혼자 고민하기보다는 전문가의 도움을 통해 자신의 감정을 돌보고, 더 효과적인 양육 방법을 찾아보는 것을 적극적으로 권장합니다." }, mixed: "<p>전반적으로 척도별 점수 차이가 크지 않아, <strong>상황에 따라 다양한 양육 방식을 사용하는 균형 잡힌 모습</strong>을 보입니다. 혹은 특정 양육 방식에 치우치기보다 유연하게 대처하는 '혼합형'으로 볼 수 있습니다.</p><p>이는 자녀의 특성이나 상황에 맞게 적절히 대응하는 장점이 될 수 있지만, 때로는 양육의 일관성이 부족하게 느껴질 수도 있습니다. 자신의 강점을 꾸준히 유지하면서, 보완이 필요한 영역에 관심을 기울이는 것이 도움이 될 것입니다.</p>" }
    };
    let appState = { currentTestType: null, testTakerInfo: null, questionsToRender: [], userResponses: [], currentPage: 0, totalPages: 0, charts: { totalScore: null } };
    const DOMElements = {};
    document.addEventListener('DOMContentLoaded', () => { ['selection-container', 'user-info-container', 'test-container', 'results-page', 'user-info-template', 'test-template', 'results-template'].forEach(id => { DOMElements[id.replace(/-/g, '_')] = document.getElementById(id); }); DOMElements.user_info_container.innerHTML = DOMElements.user_info_template.innerHTML; DOMElements.test_container.innerHTML = DOMElements.test_template.innerHTML; DOMElements.results_page.innerHTML = DOMElements.results_template.innerHTML; });
    function switchPage(pageId) { document.querySelectorAll('.page-section').forEach(p => p.style.display = 'none'); DOMElements[pageId.replace(/-/g, '_')].style.display = 'block'; }
    function formatPhoneNumber(input) { input.value = input.value.replace(/\D/g, '').replace(/(^0[0-9]{1,2})([0-9]{3,4})([0-9]{4})$/, "$1-$2-$3").replace("--", "-"); }
    function shuffle(array) { let currentIndex = array.length, randomIndex; while (currentIndex != 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--;[array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; } return array; }
    function selectTestType(userType) { appState.currentTestType = userType; switchPage('user-info-container'); document.getElementById('info-form-title').textContent = `${userType === 'parent' ? '부모용' : '자녀용'} 검사자 정보`; const nameRow = document.getElementById('additional-info-name-row'); const ageRow = document.getElementById('additional-info-age-row'); let nameLabel, nameInputId, ageLabel, ageInputId; if (userType === 'parent') { nameLabel = '자녀 이름'; nameInputId = 'child-name'; ageLabel = '자녀 나이 (세)'; ageInputId = 'child-age'; } else { nameLabel = '부모 이름'; nameInputId = 'parent-name'; ageLabel = '부모 나이 (세)'; ageInputId = 'parent-age'; } nameRow.innerHTML = `<th>${nameLabel}</th><td><input type="text" id="${nameInputId}" required></td>`; ageRow.innerHTML = `<th>${ageLabel}</th><td><input type="number" id="${ageInputId}" required></td>`; nameRow.style.display = ''; ageRow.style.display = ''; }
    function beginQuestionnaire() { const form = document.getElementById('user-info-form'); if (!form.checkValidity()) { alert('모든 정보를 정확하게 입력해주세요.'); form.reportValidity(); return; } const name = document.getElementById('user-name').value.trim(); const gender = document.querySelector('input[name="gender"]:checked').value; const age = document.getElementById('user-age').value; const contact = document.getElementById('user-contact').value.trim(); const testTakerInfo = { name, gender, age, contact }; if (appState.currentTestType === 'parent') { testTakerInfo.relationName = document.getElementById('child-name').value.trim(); testTakerInfo.relationAge = document.getElementById('child-age').value; } else { testTakerInfo.relationName = document.getElementById('parent-name').value.trim(); testTakerInfo.relationAge = document.getElementById('parent-age').value; } Object.assign(appState, { testTakerInfo, totalPages: Math.ceil(DB.questionSets[appState.currentTestType].length / CONSTANTS.QUESTIONS_PER_PAGE), questionsToRender: [...DB.questionSets[appState.currentTestType]], currentPage: 0 }); shuffle(appState.questionsToRender); appState.userResponses = new Array(appState.questionsToRender.length).fill(null); document.getElementById('test-title').textContent = `AI-PAT (${appState.currentTestType === 'parent' ? '부모용' : '자녀용'})`; document.getElementById('instruction-text').textContent = CONSTANTS.INSTRUCTION_TEXTS[appState.currentTestType]; renderCurrentPage(); switchPage('test-container'); }
    function renderCurrentPage() { const form = document.getElementById('pat-form'); const start = appState.currentPage * CONSTANTS.QUESTIONS_PER_PAGE; const end = start + CONSTANTS.QUESTIONS_PER_PAGE; let html = ''; for (let i = start; i < end && i < appState.questionsToRender.length; i++) { const question = appState.questionsToRender[i]; const checkedValue = appState.userResponses[i]; const optionsHtml = Object.keys(CONSTANTS.RESPONSE_TEXT).map(value => `<label><input type="radio" name="q${i}" onchange="saveCurrentAnswer(${i})" value="${value}" ${Number(checkedValue) === Number(value) ? 'checked' : ''}> ${CONSTANTS.RESPONSE_TEXT[value]}</label>`).join(''); html += `<div class="question-item"><div class="question-text">${i + 1}. ${question.text}</div><div class="options">${optionsHtml}</div></div>`; } form.innerHTML = html; document.getElementById('test-instructions').style.display = (appState.currentPage === 0) ? 'block' : 'none'; updateNav(); }
    function saveCurrentAnswer(index) { if (document.querySelector(`input[name="q${index}"]:checked`)) appState.userResponses[index] = parseInt(document.querySelector(`input[name="q${index}"]:checked`).value, 10); updateSubmitButtonState(); }
    function updateNav() { document.getElementById('progress-indicator').textContent = `${appState.currentPage + 1} / ${appState.totalPages} 페이지`; document.getElementById('prev-btn').disabled = appState.currentPage === 0; const isLastPage = appState.currentPage === appState.totalPages - 1; document.getElementById('next-btn').style.display = isLastPage ? 'none' : 'block'; document.getElementById('submit-btn').style.display = isLastPage ? 'block' : 'none'; updateSubmitButtonState(); }
    function updateSubmitButtonState() { if (appState.currentPage === appState.totalPages - 1) document.getElementById('submit-btn').classList.toggle('active', checkAllAnswers()); }
    function checkAllAnswers() { return appState.userResponses.every(res => res !== null); }
    function goToNextPage() { const start = appState.currentPage * CONSTANTS.QUESTIONS_PER_PAGE; const end = start + CONSTANTS.QUESTIONS_PER_PAGE; const allAnswered = appState.userResponses.slice(start, end).every(res => res !== null); if (!allAnswered && start < appState.questionsToRender.length) { alert('현재 페이지의 모든 문항에 응답해주세요.'); return; } if (appState.currentPage < appState.totalPages - 1) { appState.currentPage++; renderCurrentPage(); window.scrollTo(0, 0); } }
    function goToPrevPage() { if (appState.currentPage > 0) { appState.currentPage--; renderCurrentPage(); window.scrollTo(0, 0); } }
    async function showResults() { if (!checkAllAnswers()) { alert('모든 문항에 응답해주세요.'); return; } const loader = document.querySelector('.loader'); const loaderText = loader.querySelector('p'); loaderText.textContent = '결과를 분석하고 안전하게 저장하는 중입니다... 잠시만 기다려 주세요.'; loader.style.display = 'flex'; try { const now = new Date(); appState.testTakerInfo.date = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}. ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; await sendResultsToGoogleSheet(); } catch (error) { console.error('Google Sheet 전송 실패:', error); } finally { document.getElementById('results-title').textContent = `${appState.currentTestType === 'parent' ? '부모' : '자녀'} ${appState.testTakerInfo.name} 님의 검사 결과 분석`; renderResults(processResults()); switchPage('results-page'); document.getElementById('results-page').scrollIntoView({ behavior: 'smooth' }); loader.style.display = 'none'; } }
    function processResults() { const responsesMap = appState.questionsToRender.reduce((map, q, i) => { map[q.text] = appState.userResponses[i]; return map; }, {}); const resultData = Object.keys(CONSTANTS.SCALE_NAMES).reduce((acc, key) => ({ ...acc, [key]: { total: 0, detailed: [] } }), {}); DB.questionSets[appState.currentTestType].forEach(q => { const score = responsesMap[q.text]; if (typeof score !== 'number') return; resultData[q.scale].total += score; resultData[q.scale].detailed.push(score); }); return resultData; }
    function renderResults(results) { renderTestTakerInfo(); renderDetailedTable(results); renderAllQuestionsReview(); renderTotalScoreChart(Object.values(CONSTANTS.SCALE_NAMES), Object.values(results).map(data => data.total)); document.getElementById('general-assessment-text').innerHTML = generateGeneralAssessment(Object.keys(results).reduce((acc, key) => { acc[key] = results[key].total; return acc; }, {})); }
    
    function renderTestTakerInfo() { const { name, gender, age, contact, date, relationName, relationAge } = appState.testTakerInfo; const relationLabel = appState.currentTestType === 'parent' ? '자녀' : '부모'; document.getElementById('test-taker-info').innerHTML = `<h3>검사자 정보</h3><table class="test-taker-info-table"><tbody><tr><td class="label">검사자</td><td>${name} (${gender}, 만 ${age}세)</td><td class="label">연락처</td><td>${contact}</td></tr><tr><td class="label">${relationLabel} 정보</td><td>${relationName} (만 ${relationAge}세)</td><td class="label">검사일시</td><td>${date}</td></tr></tbody></table>`; }

    function renderDetailedTable(results) {
        const container = document.getElementById('detailed-scores-container');
        container.innerHTML = ''; 

        Object.entries(results).forEach(([scaleKey, data]) => {
            const keywords = QUESTION_KEYWORDS[scaleKey];
            let tableHtml = `<table class="detailed-scores-table"><thead><tr>`;
            tableHtml += `<th class="scale-name-col">${CONSTANTS.SCALE_NAMES[scaleKey]} (${scaleKey})</th>`;
            keywords.forEach(keyword => {
                tableHtml += `<th>${keyword}</th>`;
            });
            tableHtml += `</tr></thead><tbody><tr>`;
            tableHtml += `<td class="scale-name-col">점수</td>`;

            data.detailed.forEach(s => {
                let style = '';
                if (s === 1) { style = `style="color: var(--score-low-color);"`;
                } else if (s === 4) { style = `style="color: var(--score-high-color);"`;
                }
                tableHtml += `<td class="score" ${style}>${s}</td>`;
            });
            
            tableHtml += `</tr></tbody></table>`;
            container.innerHTML += tableHtml;
        });
    }
    
    function renderAllQuestionsReview() {
        const container = document.getElementById('all-questions-review-container'); if (!container) return; 
        const responsesMap = appState.questionsToRender.reduce((map, q, i) => { map[q.text] = appState.userResponses[i]; return map; }, {}); 
        let html = '';
        Object.keys(CONSTANTS.SCALE_NAMES).forEach(scaleKey => {
            html += `<div class="review-scale-container">`; 
            const scaleName = CONSTANTS.SCALE_NAMES[scaleKey]; 
            const scaleColor = CONSTANTS.SCALE_COLORS[scaleKey]; 
            html += `<div class="review-scale-header" style="border-left-color: ${scaleColor};"><h4>${scaleName} (${scaleKey})</h4></div>`; 
            const questionsForScale = DB.questionSets[appState.currentTestType].filter(q => q.scale === scaleKey);
            html += `<ul class="question-review-list">`; 
            let scaleQuestionIndex = 0; 
            questionsForScale.forEach(question => {
                const score = responsesMap[question.text];
                if (score === undefined) return; 
                const responseText = CONSTANTS.RESPONSE_TEXT[score] || '미응답';

                let badgeStyle = `background-color: ${scaleColor};`;
                if (score === 1) {
                    badgeStyle += ` border-color: var(--score-low-color); box-shadow: 0 0 4px var(--score-low-color);`;
                } else if (score === 4) {
                    badgeStyle += ` border-color: var(--score-high-color); box-shadow: 0 0 4px var(--score-high-color);`;
                }
                
                let followUpHtml = '';
                if (score === 1 || score === 4) {
                    const followUpQs = DB.followUpQuestions[appState.currentTestType]?.[scaleKey]?.[scaleQuestionIndex]; 
                    if (followUpQs) { 
                        const followUpText = (score === 1) ? followUpQs.q1 : followUpQs.q4; 
                        followUpHtml = `<div class="follow-up-q-box-inline"><strong style="color:${scaleColor};">[탐색 질문]</strong> ${followUpText}</div>`; 
                    } 
                } 
                html += `<li class="question-review-item"><div class="review-item-main"><span class="review-question-text">${question.text}</span><span class="user-response-badge" style="${badgeStyle}">${score}점 - ${responseText}</span></div>${followUpHtml}</li>`;
                scaleQuestionIndex++; 
            });
            html += `</ul></div>`;
        });
        container.innerHTML = html;
    }
    
    function renderTotalScoreChart(labels, scores) { if (appState.charts.totalScore) appState.charts.totalScore.destroy(); appState.charts.totalScore = new Chart(document.getElementById('total-scores-chart'), { type: 'line', data: { labels, datasets: [{ label: '척도별 총점', data: scores, fill: true, backgroundColor: 'rgba(52, 152, 219, 0.2)', borderColor: 'rgb(52, 152, 219)', tension: 0.1 }] }, options: { animation: false, responsive: true, maintainAspectRatio: false, scales: { y: { min: 8, max: 32, title: { display: true, text: '총점 (8점 ~ 32점)' } } }, plugins: { legend: { display: false } } } }); }
    function generateGeneralAssessment(scores) { const sortedScores = Object.entries(scores).map(([key, score]) => ({ key, score })).sort((a, b) => b.score - a.score); const [highest, lowest] = [sortedScores[0], sortedScores[sortedScores.length - 1]]; if (highest.score - lowest.score <= 4) return DB.assessmentTexts.mixed; let assessment = `<p>검사 결과, ${appState.testTakerInfo.name}님의 양육태도에서 가장 두드러지는 특징과 상대적으로 덜 사용하는 특징은 다음과 같습니다.</p><p>${DB.assessmentTexts[highest.key].highest}</p><p>반면, ${DB.assessmentTexts[lowest.key].lowest}</p>`; let conclusionType = highest.key.startsWith('A') && highest.score >= 26 ? 'positive' : (highest.key === 'C5' && highest.score >= 24 ? 'warning' : 'neutral'); assessment += `<p>${DB.assessmentTexts.conclusion[conclusionType]}</p>`; return assessment; }
    async function sendResultsToGoogleSheet() { if (!SCRIPT_URL || SCRIPT_URL.includes('여기에')) { throw new Error('Google Apps Script URL이 설정되지 않았습니다.'); } try { const results = processResults(); const transformedData = new FormData(); transformedData.append('testerName', appState.testTakerInfo.name); transformedData.append('testDate', appState.testTakerInfo.date); const scalesInOrder = ['A1', 'A2', 'B3', 'B4', 'C5']; let questionCounter = 1; scalesInOrder.forEach(scaleKey => { if (results[scaleKey] && results[scaleKey].detailed) { results[scaleKey].detailed.forEach(score => { transformedData.append(`Q${questionCounter}`, score); questionCounter++; }); } }); const response = await fetch(SCRIPT_URL, { method: 'POST', body: transformedData }); const data = await response.json(); if (data.result !== 'success') { throw new Error(data.message || '알 수 없는 서버 오류'); } console.log("Google Sheet 전송 성공:", data); } catch (error) { console.error('Google Sheet 전송 중 캐치된 에러:', error); throw error; } }
    
    async function downloadResultsAsPdf() {
        const {name, date, contact} = appState.testTakerInfo;
        const testType = appState.currentTestType === 'parent' ? '부모용' : '자녀용';
        const loader = document.querySelector('.loader');
        loader.style.display = 'flex';
        
        document.body.style.width = '800px'; 
        
        try {
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            let y = margin;
            
            const addPageWithYReset = () => { pdf.addPage(); return margin; };

            const addElement = async (element) => {
                if (!element) return;
                const canvas = await html2canvas(element, { scale: 2, useCORS: true, logging: false });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const imgWidth = pdfWidth - (margin * 2);
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                if (y + imgHeight > pdfHeight - margin) {
                    y = addPageWithYReset();
                }
                pdf.addImage(imgData, 'JPEG', margin, y, imgWidth, imgHeight, undefined, 'SLOW');
                y += imgHeight;
            };

            loader.innerHTML = '<p>1/4. 보고서 표지 생성 중...</p>';
            const coverDiv = document.createElement('div');
            Object.assign(coverDiv.style, {
                position: 'absolute', top: '-9999px', left: 0,
                width: '800px', height: '1131px',
                backgroundColor: 'white',
                boxSizing: 'border-box',
                fontFamily: `'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`,
                display: 'flex',
                flexDirection: 'column'
            });
            
            const fontLink = document.createElement('link');
            fontLink.href = 'https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css';
            fontLink.rel = 'stylesheet';
            fontLink.type = 'text/css';
            document.head.appendChild(fontLink);

            // [업데이트] 제목/부제목 위치 조정
            coverDiv.innerHTML = `
                <!-- 1. 상단: 제목/부제 영역 -->
                <div style="flex: 1.5; display: flex; flex-direction: column; justify-content: center; text-align: center; padding: 40px;">
                    <h1 style="font-size: 3em; margin: 0 0 40px 0; color: #1e2a3b; font-weight: 800; letter-spacing: -1.5px;">
                        AI-PAT 결과 보고서
                    </h1>
                    <div style="width: 80px; height: 4px; background-color: #3498db; margin: 0 auto 30px auto;"></div>
                    <p style="font-size: 1.2em; margin: 0 0 8px 0; color: #5c677d; font-weight: 500; letter-spacing: 0.5px;">
                        Awareness & Insight Parenting Attitude Test
                    </p>
                    <p style="font-size: 1.1em; font-weight: 500; margin: 0; color: #555;">
                        [ 부모의 통찰과 양육태도 인식검사 ]
                    </p>
                </div>

                <!-- 2. 중앙: 검사자 정보 영역 -->
                <div style="flex: 1; padding: 0 60px 40px 60px;">
                     <div style="width: 100%; max-width: 500px; margin: 0 auto; border-top: 1px solid #e0e0e0; padding-top: 40px; font-size: 1.1em; line-height: 2.0; color: #555;">
                        <p style="margin:0;"><strong style="display:inline-block; width: 90px; color: #000;">검 사 자</strong>: ${name}</p>
                        <p style="margin:0;"><strong style="display:inline-block; width: 90px; color: #000;">검사 일시</strong>: ${date}</p>
                    </div>
                </div>

                <!-- 3. 하단: 저작권 영역 -->
                <div style="flex: 0 0 auto; padding: 30px 60px; font-size: 0.8em; color: #888; text-align: center; border-top: 1px solid #f0f0f0;">
                    <p style="margin: 0 0 8px 0; font-weight: bold; color: #555;">
                        © Real-Life Coaching Center. All rights reserved.
                    </p>
                    <p style="margin: 0; font-style: italic;">
                        본 검사 결과 보고서의 모든 내용에 대한 저작권은 리얼라이프 라이프코칭센터에 있습니다.<br>
                        센터의 사전 서면 동의 없이 무단으로 복제, 배포, 수정하거나 상업적으로 이용하는 행위를 일체 금합니다.
                    </p>
                </div>
            `;
            document.body.appendChild(coverDiv);
            await addElement(coverDiv);
            document.body.removeChild(coverDiv);
            document.head.removeChild(fontLink);
            
            y = addPageWithYReset();

            loader.innerHTML = '<p>2/4. 기본 정보 생성 중...</p>';
            await addElement(document.getElementById('test-taker-info'));
            y += 10;
            
            loader.innerHTML = '<p>3/4. 분석 결과 생성 중...</p>';
            await addElement(document.getElementById('general-assessment-card'));
            await addElement(document.getElementById('total-scores-chart-card'));
            await addElement(document.getElementById('detailed-scores-card'));
            
            loader.innerHTML = '<p>4/4. 상세 문항 분석 중...</p>';
            y = addPageWithYReset();
            
            const detailedReviewTitle = document.querySelector('#all-questions-review-card > h3');
            if(detailedReviewTitle) await addElement(detailedReviewTitle);
            
            const reviewContainers = document.querySelectorAll('.review-scale-container');
            for(let i = 0; i < reviewContainers.length; i++) {
                loader.innerHTML = `<p>4/4. 상세 문항 분석 중... (${i+1}/${reviewContainers.length})</p>`;
                const elementCanvas = await html2canvas(reviewContainers[i], { scale: 2 });
                const elementHeight = (elementCanvas.height * (pdfWidth - margin * 2)) / elementCanvas.width;
                if(y + elementHeight > pdfHeight - margin){
                    y = addPageWithYReset();
                    if(detailedReviewTitle) await addElement(detailedReviewTitle);
                }
                await addElement(reviewContainers[i]);
            }
            
            pdf.save(`AI-PAT_결과보고서_${name}_${new Date().getTime()}.pdf`);
            
        } catch(error) { 
            console.error("PDF 생성 중 오류 발생:", error);
            alert("PDF 생성에 실패했습니다. F12를 눌러 개발자 콘솔의 오류 메시지를 확인해주세요.");
        } finally {
            document.body.style.width = '';
            loader.style.display = 'none';
            loader.innerHTML = '<p></p>';
        }
    }
    
    function printResults() { window.print(); }
    function restartTest() { document.getElementById('user-info-form')?.reset(); if (appState.charts.totalScore) appState.charts.totalScore.destroy(); appState = { currentTestType: null, testTakerInfo: null, questionsToRender: [], userResponses: [], currentPage: 0, totalPages: 0, charts: { totalScore: null } }; switchPage('selection-container'); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    
    </script>
</body>
</html>
